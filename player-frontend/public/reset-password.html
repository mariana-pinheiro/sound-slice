<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redefinir Palavra‑passe</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <header class="bg-[#0b1d2c] text-white px-8 py-4 shadow">
    <div class="flex items-center space-x-2 text-2xl font-bold">
      <img src="images/icon.png" alt="Logo" class="h-8 w-auto">
      <span>SoundSlice</span>
    </div>
  </header>

  <main class="flex items-center justify-center min-h-[calc(100vh-72px)] px-4">
    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
      <h1 class="text-2xl font-semibold text-center text-slate-800 mb-6">Redefinir Palavra‑passe</h1>

      <form id="resetForm" class="space-y-5">
        <div>
          <label class="block mb-2 text-slate-800 font-semibold" for="newPassword">Nova Palavra‑passe</label>
          <div class="relative">
            <input id="newPassword" type="password"
                   class="w-full rounded-lg border border-gray-200 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                   required />
            <button type="button"
                    class="absolute right-0 top-1/2 -translate-y-1/2 px-3 text-gray-500"
                    onclick="togglePassword('newPassword', this)"
                    aria-label="Mostrar/ocultar palavra‑passe">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                   stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
        </div>

        <div>
          <label class="block mb-2 text-slate-800 font-semibold" for="confirmPassword">Confirmar Palavra‑passe</label>
          <div class="relative">
            <input id="confirmPassword" type="password"
                   class="w-full rounded-lg border border-gray-200 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                   required />
            <button type="button"
                    class="absolute right-0 top-1/2 -translate-y-1/2 px-3 text-gray-500"
                    onclick="togglePassword('confirmPassword', this)"
                    aria-label="Mostrar/ocultar palavra‑passe">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                   stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
        </div>

        <button type="submit"
                class="w-full rounded-lg px-4 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-medium">
          Atualizar
        </button>
      </form>

      <p id="status" class="text-center text-slate-600 mt-4"></p>
      <p class="text-center text-sm text-slate-500 mt-2">
        Lembrou-se? <a href="login.html" class="text-indigo-600 hover:underline">Voltar ao login</a> 
      </p>
    </div>
  </main>
  <div id="toast-root" class="fixed z-50 bottom-6 right-6 space-y-3 pointer-events-none"></div>

<script>
  const API = 'http://localhost:3000';

  function togglePassword(id, btn) {
    const input = document.getElementById(id);
    const icon = btn.querySelector('svg');
    if (input.type === 'password') {
      input.type = 'text';
      icon.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.969 9.969 0 012.807-4.409m3.781-2.194A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.96 9.96 0 01-4.183 5.093M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3l18 18" />
      `;
      btn.classList.add('text-indigo-600');
    } else {
      input.type = 'password';
      icon.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
      `;
      btn.classList.remove('text-indigo-600');
    }
  }

  const form = document.getElementById('resetForm');
  const statusEl = document.getElementById('status');
  const submitBtn = form.querySelector('button[type="submit"]');
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');

  if (!token) {
    statusEl.textContent = 'Token inválido.';
    submitBtn.disabled = true;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();

    if (newPassword !== confirmPassword) {
      statusEl.textContent = 'As palavras‑passe não coincidem.';
      return;
    }

    submitBtn.disabled = true;
    statusEl.textContent = 'A atualizar...';

    try {
      const res = await fetch(`${API}/api/users/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, newPassword })
      });
      const data = await res.json();

      if (!res.ok) {
        statusEl.textContent = data.error || 'Erro ao atualizar password.';
      } else {
        statusEl.textContent = data.message || 'Password atualizada com sucesso!';
        form.reset();
      }
    } catch {
      statusEl.textContent = 'Erro ao atualizar password.';
    } finally {
      submitBtn.disabled = false;
    }
  });

  function notify(message, type = 'info', timeout = 3000) {
            const root = document.getElementById('toast-root');
            const wrap = document.createElement('div');
            wrap.className = "pointer-events-auto w-[320px] rounded-lg shadow-lg border bg-white flex items-start gap-3 p-4 animate-[fadein_.2s_ease-out]";
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-200',
                error: 'bg-rose-100 text-rose-800 border-rose-200',
                info: 'bg-indigo-100 text-indigo-800 border-indigo-200'
            };
            const badge = document.createElement('div');
            badge.className = `shrink-0 h-6 w-6 rounded-full flex items-center justify-center ${colors[type]}`;
            badge.innerHTML = ({
                success: '✓', error: '!', info: 'i'
            })[type];

            const text = document.createElement('div');
            text.className = "text-sm text-slate-700";
            text.textContent = message;

            const close = document.createElement('button');
            close.className = "ml-auto text-slate-400 hover:text-slate-600";
            close.innerHTML = '&times;';
            close.onclick = () => root.removeChild(wrap);

            wrap.appendChild(badge);
            wrap.appendChild(text);
            wrap.appendChild(close);
            root.appendChild(wrap);

            setTimeout(() => {
                if (wrap.parentNode) root.removeChild(wrap);
            }, timeout);
        }
</script>
</body>
</html>
