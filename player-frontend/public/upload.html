<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoundSlice — Upload Música</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-custom-dark {
            background-color: #091a2b;
        }

        .text-custom-blue {
            color: #00a2fd;
        }

        .hover\:text-custom-blue:hover {
            color: #00a2fd;
        }

        .bg-custom-blue {
            background-color: #00a2fd;
        }

        .hover\:bg-custom-blue:hover {
            background-color: #0090e0;
        }
        
        @keyframes fadein {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-custom-dark text-white flex items-center justify-between px-8 py-4 shadow-md">
        <a href="index.html" class="flex items-center space-x-2 text-2xl font-bold cursor-pointer">
            <img src="images/icon.png" alt="Logo SoundSlice" class="h-8 w-auto">
            <span>SoundSlice</span>
        </a>

        <nav class="flex items-center space-x-6 text-white text-lg">
            <a href="musicas-outros.html" class="hover:text-[#00a2fd] transition ">
                Músicas de Outros Criadores
            </a>
            <a href="minhas-musicas.html" class="hover:text-[#00a2fd] transition underline">
                Minhas Músicas
            </a>

            <!-- Quando user não está autenticado -->
            <a id="auth-link" href="login.html" class="hover:text-[#00a2fd] transition">
                Login/Registe-se
            </a>

            <!-- Quando user está autenticado -->
            <div class="relative hidden" id="userMenuWrapper">
                <button id="userMenuBtn" class="flex items-center space-x-2 focus:outline-none">
                    <img id="profilePic" src="images/default-avatar.png" alt="Avatar"
                        class="h-8 w-8 rounded-full border border-gray-300">
                    <span id="welcomeName"></span>
                </button>

                <!-- Dropdown -->
                <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white text-black rounded shadow-lg hidden">
                    <a href="profile.html" class="block px-4 py-2 hover:bg-gray-100">O meu perfil</a>
                    <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100">Logout</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-grow max-w-2xl mx-auto p-6 w-full">
        <h1 class="text-2xl font-bold text-slate-900 mb-6">Enviar nova música</h1>

        <form id="uploadForm" class="space-y-6 bg-white p-6 rounded-lg shadow">
            <div>
                <label class="block font-medium mb-1">Título</label>
                <input type="text" id="title" required class="w-full rounded-md border px-3 py-2" />
            </div>

            <div>
                <label class="block font-medium mb-1">Artista</label>
                <input type="text" id="artist" required class="w-full rounded-md border px-3 py-2" />
            </div>
            <label for="genre" class="block text-sm font-medium text-slate-700 mb-1">
                Género Musical
            </label>
            <select id="genre" name="genre" class="w-full rounded border border-gray-300 px-3 py-2 mb-4">
                <option value="">Seleciona o género</option>
                <option value="Pop">Pop</option>
                <option value="Rock">Rock</option>
                <option value="Jazz">Jazz</option>
                <option value="Hip-Hop">Hip-Hop</option>
                <option value="Eletrónica">Eletrónica</option>
                <option value="R&B">R&B</option>
                <option value="Folk">Folk</option>
                <option value="Reggae">Reggae</option>
                <option value="Clássica">Clássica</option>
                <option value="Lo-Fi">Lo-Fi</option>
                <option value="Instrumental">Instrumental</option>
            </select>
            <div>
                <label class="block font-medium mb-1">Ficheiro de música</label>
                <input type="file" id="file" accept="audio/*" required class="w-full" />
            </div>
            <div id="previewPlayer"></div>

            <div>
                <label class="block font-medium mb-1">Imagem de capa</label>
                <input type="file" id="cover" name="cover" accept="image/*" class="w-full" />
            </div>

            <div>
                <label class="block font-medium mb-1">Visibilidade</label>
                <select id="visibility" class="w-full rounded-md border px-3 py-2">
                    <option value="public">Pública</option>
                    <option value="private">Privada</option>
                </select>
            </div>

            <!-- Campos específicos para contrato -->
            <div>
                <label class="block font-medium mb-1">Preço base</label>
                <input type="number" id="price" min="0" required class="w-full rounded-md border px-3 py-2"
                    placeholder=" ETH" />
            </div>

            <!-- Novos campos -->
            <div>
                <label class="block font-medium mb-1">Formato</label>
                <input type="text" id="format" readonly class="w-full rounded-md border px-3 py-2 bg-gray-100" />
            </div>

            <div>
                <label class="block font-medium mb-1">Duração (segundos)</label>
                <input type="text" id="duration" readonly class="w-full rounded-md border px-3 py-2 bg-gray-100" />
            </div>

            <div>
                <label class="block font-medium mb-1">Extra Metadata (JSON)</label>
                <textarea id="extra" readonly class="w-full rounded-md border px-3 py-2 bg-gray-100 h-24"></textarea>
            </div>

            <!-- Outros titulares -->
            <div class="border-t pt-4">
                <!-- ... resto igual ... -->
            </div>

            <!-- Outros titulares -->
            <div class="border-t pt-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="hasCoHolders" class="w-4 h-4">
                    <span>Adicionar outros titulares?</span>
                </label>
                <div id="holdersSection" class="hidden mt-4 space-y-3">
                    <div id="holdersList"></div>
                    <button type="button" id="addHolder" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                        ➕ Adicionar titular
                    </button>
                </div>
            </div>

            <!-- Metadados automáticos -->
            <div class="border-t pt-4">
                <h2 class="text-lg font-semibold mb-3"> Metadados</h2>
                <pre id="metadataPreview"
                    class="bg-slate-50 border rounded-md p-3 text-sm text-slate-700">Nenhum ficheiro carregado ainda.</pre>
            </div>

            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                Upload da Música
            </button>
        </form>

        <div id="status" class="mt-4 text-sm text-slate-600"></div>
    </main>

    <footer class="bg-custom-dark text-white py-6 mt-auto">
        <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <p class="text-sm">&copy; <span id="year"></span> SoundSlice. Todos os direitos reservados.</p>
            <div class="flex space-x-4 mt-4 md:mt-0">
                <a href="sobre.html" class="hover:text-custom-blue">Sobre</a>
                <a href="contactos.html" class="hover:text-custom-blue">Contactos</a>
                <a href="polpriv.html" class="hover:text-custom-blue">Política de Privacidade</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.min.js";

        const API = "http://localhost:3000";
        document.getElementById('year').textContent = new Date().getFullYear();

        // -------- Sessão --------
        async function loadUser() {
            try {
                const token = localStorage.getItem("authToken");
                if (!token) {
                    document.getElementById("auth-link").style.display = "inline-block";
                    document.getElementById("userMenuWrapper").classList.add("hidden");
                    return;
                }
                const res = await fetch(`${API}/api/users/me`, {
                    headers: { Authorization: "Bearer " + token }
                });

                if (res.ok) {
                    const user = await res.json();

                    // Nome
                    document.getElementById("welcomeName").textContent = "Olá " + (user.firstname || "Utilizador");

                    // Foto de perfil
                    const picEl = document.getElementById("profilePic");
                    if (user.profilePic) {
                        picEl.src = user.profilePic;
                    } else {
                        picEl.src = "images/default-avatar.png";
                    }

                    // Alterna menus
                    document.getElementById("auth-link").style.display = "none";
                    document.getElementById("userMenuWrapper").classList.remove("hidden");
                } else {
                    // não autenticado
                    document.getElementById("auth-link").style.display = "inline-block";
                    document.getElementById("userMenuWrapper").classList.add("hidden");
                }
            } catch (err) {
                console.error("Erro a carregar user:", err);
            }
        }

        // Dropdown
        document.addEventListener("click", (e) => {
            const menu = document.getElementById("userDropdown");
            const btn = document.getElementById("userMenuBtn");

            if (btn && btn.contains(e.target)) {
                menu.classList.toggle("hidden");
            } else {
                menu.classList.add("hidden");
            }
        });

        // Logout
        document.getElementById("logoutBtn")?.addEventListener("click", () => {
            localStorage.removeItem("authToken");
            localStorage.removeItem("nameCache");
            window.location.href = "login.html";
        });

        loadUser();

        const CONTRACT_ABI = [
            "constructor(string _title,string _artist,bytes32 _fileHash,uint256 _basePrice,string _format,string _genre,uint256 _duration,string _extra,address[] _holders,uint256[] _shares)",
            "function title() view returns (string)",
            "function artist() view returns (string)",
            "function fileHash() view returns (bytes32)",
            "function basePrice() view returns (uint256)",
            "function totalReuses() view returns (uint256)"
        ];

        const CONTRACT_BYTECODE = "0x608060405234801561001057600080fd5b5060405161211638038061211683398181016040528101906100329190610709565b8051825114610076576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161006d9061092f565b60405180910390fd5b6000805b835181101561019557600560405180604001604052808684815181106100a3576100a261094f565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1681526020018584815181106100d9576100d861094f565b5b6020026020010151815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015550508281815181106101735761017261094f565b5b60200260200101518261018691906109ad565b9150808060010191505061007a565b50606481146101d9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101d090610a53565b60405180910390fd5b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508a600190816102289190610c8a565b5089600290816102389190610c8a565b5088600381905550876004819055506040518060800160405280888152602001878152602001868152602001858152506007600082015181600001908161027f9190610c8a565b5060208201518160010190816102959190610c8a565b506040820151816002015560608201518160030190816102b59190610c8a565b5090505060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f26a27fccb09677f3adbd89f92c2ad016d23f8c6497ea9bcb14b39749484d75b56001600260035460405161032793929190610def565b60405180910390a25050505050505050505050610e34565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6103a68261035d565b810181811067ffffffffffffffff821117156103c5576103c461036e565b5b80604052505050565b60006103d861033f565b90506103e4828261039d565b919050565b600067ffffffffffffffff8211156104045761040361036e565b5b61040d8261035d565b9050602081019050919050565b60005b8381101561043857808201518184015260208101905061041d565b60008484015250505050565b6000610457610452846103e9565b6103ce565b90508281526020810184848401111561047357610472610358565b5b61047e84828561041a565b509392505050565b600082601f83011261049b5761049a610353565b5b81516104ab848260208601610444565b91505092915050565b6000819050919050565b6104c7816104b4565b81146104d257600080fd5b50565b6000815190506104e4816104be565b92915050565b6000819050919050565b6104fd816104ea565b811461050857600080fd5b50565b60008151905061051a816104f4565b92915050565b600067ffffffffffffffff82111561053b5761053a61036e565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061057c82610551565b9050919050565b61058c81610571565b811461059757600080fd5b50565b6000815190506105a981610583565b92915050565b60006105c26105bd84610520565b6103ce565b905080838252602082019050602084028301858111156105e5576105e461054c565b5b835b8181101561060e57806105fa888261059a565b8452602084019350506020810190506105e7565b5050509392505050565b600082601f83011261062d5761062c610353565b5b815161063d8482602086016105af565b91505092915050565b600067ffffffffffffffff8211156106615761066061036e565b5b602082029050602081019050919050565b600061068561068084610646565b6103ce565b905080838252602082019050602084028301858111156106a8576106a761054c565b5b835b818110156106d157806106bd888261050b565b8452602084019350506020810190506106aa565b5050509392505050565b600082601f8301126106f0576106ef610353565b5b8151610700848260208601610672565b91505092915050565b6000806000806000806000806000806101408b8d03121561072d5761072c610349565b5b60008b015167ffffffffffffffff81111561074b5761074a61034e565b5b6107578d828e01610486565b9a505060208b015167ffffffffffffffff8111156107785761077761034e565b5b6107848d828e01610486565b99505060406107958d828e016104d5565b98505060606107a68d828e0161050b565b97505060808b015167ffffffffffffffff8111156107c7576107c661034e565b5b6107d38d828e01610486565b96505060a08b015167ffffffffffffffff8111156107f4576107f361034e565b5b6108008d828e01610486565b95505060c06108118d828e0161050b565b94505060e08b015167ffffffffffffffff8111156108325761083161034e565b5b61083e8d828e01610486565b9350506101008b015167ffffffffffffffff8111156108605761085f61034e565b5b61086c8d828e01610618565b9250506101208b015167ffffffffffffffff81111561088e5761088d61034e565b5b61089a8d828e016106db565b9150509295989b9194979a5092959850565b600082825260208201905092915050565b7f546974756c6172657320652070657263656e746167656e7320646573616c696e60008201527f6861646f73000000000000000000000000000000000000000000000000000000602082015250565b60006109196025836108ac565b9150610924826108bd565b604082019050919050565b600060208201905081810360008301526109488161090c565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006109b8826104ea565b91506109c3836104ea565b92508282019050808211156109db576109da61097e565b5b92915050565b7f546f74616c2064652070657263656e746167656e73206465766520736572203160008201527f3030000000000000000000000000000000000000000000000000000000000000602082015250565b6000610a3d6022836108ac565b9150610a48826109e1565b604082019050919050565b60006020820190508181036000830152610a6c81610a30565b9050919050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610ac557607f821691505b602082108103610ad857610ad7610a7e565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610b407fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610b03565b610b4a8683610b03565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610b87610b82610b7d846104ea565b610b62565b6104ea565b9050919050565b6000819050919050565b610ba183610b6c565b610bb5610bad82610b8e565b848454610b10565b825550505050565b600090565b610bca610bbd565b610bd5818484610b98565b505050565b5b81811015610bf957610bee600082610bc2565b600181019050610bdb565b5050565b601f821115610c3e57610c0f81610ade565b610c1884610af3565b81016020851015610c27578190505b610c3b610c3385610af3565b830182610bda565b50505b505050565b600082821c905092915050565b6000610c6160001984600802610c43565b1980831691505092915050565b6000610c7a8383610c50565b9150826002028217905092915050565b610c9382610a73565b67ffffffffffffffff811115610cac57610cab61036e565b5b610cb68254610aad565b610cc1828285610bfd565b600060209050601f831160018114610cf45760008415610ce2578287015190505b610cec8582610c6e565b865550610d54565b601f198416610d0286610ade565b60005b82811015610d2a57848901518255600182019150602085019450602081019050610d05565b86831015610d475784890151610d43601f891682610c50565b8355505b6001600288020188555050505b505050505050565b60008154610d6981610aad565b610d7381866108ac565b94506001821660008114610d8e5760018114610da457610dd7565b60ff198316865281151560200286019350610dd7565b610dad85610ade565b60005b83811015610dcf57815481890152600182019150602081019050610db0565b808801955050505b50505092915050565b610de9816104b4565b82525050565b60006060820190508181036000830152610e098186610d5c565b90508181036020830152610e1d8185610d5c565b9050610e2c6040830184610de0565b949350505050565b6112d380610e436000396000f3fe6080604052600436106100a75760003560e01c80637a5b4f59116100645780637a5b4f59146101d95780638da5cb5b146102085780638e9046ef14610233578063968bc5f01461024f578063b0b142fa1461027a578063c7876ea4146102ba576100a7565b806324c8c698146100ac5780632c326201146100d7578063392f37e91461011757806343bc1612146101455780634a79d50c146101705780635d0fab841461019b575b600080fd5b3480156100b857600080fd5b506100c16102e5565b6040516100ce9190610d4a565b60405180910390f35b3480156100e357600080fd5b506100fe60048036038101906100f99190610da0565b6102eb565b60405161010e9493929190610e1d565b60405180910390f35b34801561012357600080fd5b5061012c6103ba565b60405161013c9493929190610ef2565b60405180910390f35b34801561015157600080fd5b5061015a610570565b6040516101679190610f4c565b60405180910390f35b34801561017c57600080fd5b506101856105fe565b6040516101929190610f4c565b60405180910390f35b3480156101a757600080fd5b506101c260048036038101906101bd9190610da0565b61068c565b6040516101d0929190610f6e565b60405180910390f35b3480156101e557600080fd5b506101ee6106e0565b6040516101ff959493929190610f97565b60405180910390f35b34801561021457600080fd5b5061021d610941565b60405161022a9190611006565b60405180910390f35b61024d60048036038101906102489190610da0565b610965565b005b34801561025b57600080fd5b50610264610b3c565b6040516102719190611021565b60405180910390f35b34801561028657600080fd5b506102a1600480360381019061029c9190610da0565b610b49565b6040516102b19493929190610e1d565b60405180910390f35b3480156102c657600080fd5b506102cf610ba9565b6040516102dc9190611021565b60405180910390f35b60035481565b6000806000806000600686815481106103075761030661103c565b5b90600052602060002090600402016040518060800160405290816000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016001820154815260200160028201548152602001600382015481525050905080600001518160200151826040015183606001519450945094509450509193509193565b60078060000180546103cb9061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546103f79061109a565b80156104445780601f1061041957610100808354040283529160200191610444565b820191906000526020600020905b81548152906001019060200180831161042757829003601f168201915b5050505050908060010180546104599061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546104859061109a565b80156104d25780601f106104a7576101008083540402835291602001916104d2565b820191906000526020600020905b8154815290600101906020018083116104b557829003601f168201915b5050505050908060020154908060030180546104ed9061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546105199061109a565b80156105665780601f1061053b57610100808354040283529160200191610566565b820191906000526020600020905b81548152906001019060200180831161054957829003601f168201915b5050505050905084565b6002805461057d9061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546105a99061109a565b80156105f65780601f106105cb576101008083540402835291602001916105f6565b820191906000526020600020905b8154815290600101906020018083116105d957829003601f168201915b505050505081565b6001805461060b9061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546106379061109a565b80156106845780601f1061065957610100808354040283529160200191610684565b820191906000526020600020905b81548152906001019060200180831161066757829003601f168201915b505050505081565b6005818154811061069c57600080fd5b90600052602060002090600202016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154905082565b606080606060006060600760000160076001016001600760020154600760030184805461070c9061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546107389061109a565b80156107855780601f1061075a57610100808354040283529160200191610785565b820191906000526020600020905b81548152906001019060200180831161076857829003601f168201915b505050505094508380546107989061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546107c49061109a565b80156108115780601f106107e657610100808354040283529160200191610811565b820191906000526020600020905b8154815290600101906020018083116107f457829003601f168201915b505050505093508280546108249061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546108509061109a565b801561089d5780601f106108725761010080835404028352916020019161089d565b820191906000526020600020905b81548152906001019060200180831161088057829003601f168201915b505050505092508080546108b09061109a565b80601f01602080910402602001604051908101604052809291908181526020018280546108dc9061109a565b80156109295780601f106108fe57610100808354040283529160200191610929565b820191906000526020600020905b81548152906001019060200180831161090c57829003601f168201915b50505050509050945094509450945094509091929394565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600081118015610976575060648111155b6109b5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109ac90611117565b60405180910390fd5b60006064826004546109c79190611166565b6109d191906111d7565b905080341015610a16576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a0d90611254565b60405180910390fd5b600660405180608001604052803373ffffffffffffffffffffffffffffffffffffffff16815260200184815260200183815260200142815250908060018154018082558091505060019003906000526020600020906004020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010155604082015181600201556060820151816003015550503373ffffffffffffffffffffffffffffffffffffffff167f39f787a7da272ea7f98f6c46e725fcb0e8bcbe330576fd6157d6fab543b9de1f8383604051610b27929190611274565b60405180910390a2610b3881610baf565b5050565b6000600680549050905090565b60068181548110610b5957600080fd5b90600052602060002090600402016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030154905084565b60045481565b60005b600580549050811015610d2d576000606460058381548110610bd757610bd661103c565b5b90600052602060002090600202016001015484610bf49190611166565b610bfe91906111d7565b905060058281548110610c1457610c1361103c565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610c8b573d6000803e3d6000fd5b5060058281548110610ca057610c9f61103c565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167fc34f30165071f2be6258315cf60279fa343e720cdf6a8b91c1660270d201ea6d82604051610d179190611021565b60405180910390a2508080600101915050610bb2565b5050565b6000819050919050565b610d4481610d31565b82525050565b6000602082019050610d5f6000830184610d3b565b92915050565b600080fd5b6000819050919050565b610d7d81610d6a565b8114610d8857600080fd5b50565b600081359050610d9a81610d74565b92915050565b600060208284031215610db657610db5610d65565b5b6000610dc484828501610d8b565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610df882610dcd565b9050919050565b610e0881610ded565b82525050565b610e1781610d6a565b82525050565b6000608082019050610e326000830187610dff565b610e3f6020830186610e0e565b610e4c6040830185610e0e565b610e596060830184610e0e565b95945050505050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610e9c578082015181840152602081019050610e81565b60008484015250505050565b6000601f19601f8301169050919050565b6000610ec482610e62565b610ece8185610e6d565b9350610ede818560208601610e7e565b610ee781610ea8565b840191505092915050565b60006080820190508181036000830152610f0c8187610eb9565b90508181036020830152610f208186610eb9565b9050610f2f6040830185610e0e565b8181036060830152610f418184610eb9565b905095945050505050565b60006020820190508181036000830152610f668184610eb9565b905092915050565b6000604082019050610f836000830185610dff565b610f906020830184610e0e565b9392505050565b600060a0820190508181036000830152610fb18188610eb9565b90508181036020830152610fc58187610eb9565b90508181036040830152610fd98186610eb9565b9050610fe86060830185610e0e565b8181036080830152610ffa8184610eb9565b90509695505050505050565b600060208201905061101b6000830184610dff565b92915050565b60006020820190506110366000830184610e0e565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806110b257607f821691505b6020821081036110c5576110c461106b565b5b50919050565b7f50657263656e746167656d20696e76616c696461000000000000000000000000600082015250565b6000611101601483610e6d565b915061110c826110cb565b602082019050919050565b60006020820190508181036000830152611130816110f4565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061117182610d6a565b915061117c83610d6a565b925082820261118a81610d6a565b915082820484148315176111a1576111a0611137565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60006111e282610d6a565b91506111ed83610d6a565b9250826111fd576111fc6111a8565b5b828204905092915050565b7f56616c6f7220696e737566696369656e746520656e766961646f000000000000600082015250565b600061123e601a83610e6d565b915061124982611208565b602082019050919050565b6000602082019050818103600083015261126d81611231565b9050919050565b60006040820190506112896000830185610e0e565b6112966020830184610e0e565b939250505056fea2646970667358221220638407e8aa17a552739ba49d4e9a971d144df4c5e359b5ba7c677118c7bc0f4764736f6c634300081c0033";

        const hasCoHolders = document.getElementById("hasCoHolders");
        const holdersSection = document.getElementById("holdersSection");
        const holdersList = document.getElementById("holdersList");
        const addHolderBtn = document.getElementById("addHolder");

        hasCoHolders.addEventListener("change", () => {
            holdersSection.classList.toggle("hidden", !hasCoHolders.checked);
        });

        addHolderBtn.addEventListener("click", () => {
            const div = document.createElement("div");
            div.className = "flex space-x-2";
            div.innerHTML = `
 <div class="flex space-x-2">
  <input type="text" placeholder="Nome do titular" class="holderName flex-1 border rounded px-2 py-1"/>
  <input type="number" placeholder="%" class="holderPercent flex-1 border rounded px-2 py-1"/>
  <button type="button" class="removeHolder text-red-500">❌</button>
</div>
      `;
            div.querySelector(".removeHolder").onclick = () => div.remove();
            holdersList.appendChild(div);
        });

        document.getElementById("file").addEventListener("change", e => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                document.getElementById("previewPlayer").innerHTML = `
      <audio controls controlsList="nodownload noplaybackrate class="w-full mt-3">
        <source src="${url}" type="${file.type}">
      </audio>`;
            }
        });

        document.getElementById("file").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("file", file);

            try {
                const r = await fetch(`${API}/api/tracks/metadata`, { method: "POST", body: formData });
                const data = await r.json();
                document.getElementById("metadataPreview").textContent = JSON.stringify(data, null, 2);
                window.generatedMetadata = data;
                document.getElementById("format").value = data.format || "";
                document.getElementById("duration").value = data.duration || 0;
                document.getElementById("extra").value = JSON.stringify(data, null, 2);
            } catch (err) {
                document.getElementById("metadataPreview").textContent = "Erro ao gerar metadados";
                console.error(err);
            }
        });

        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("title").value;
            const artist = document.getElementById("artist").value;
            const file = document.getElementById("file").files[0];
            const visibility = document.getElementById("visibility").value;
            let priceEth = document.getElementById("price").value;
            if (!priceEth || parseFloat(priceEth) <= 0) {
                throw new Error("Preço base inválido");
            }
            const priceWei = ethers.parseEther(priceEth.toString());
            const metadata = window.generatedMetadata || {};
            const status = document.getElementById("status");

            status.textContent = " A enviar música e a criar contrato…";

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x7A69' }] // 31337 em hexadecimal
                });

                if (!window.ethereum) throw new Error("Precisas do MetaMask!");
                const provider = new ethers.BrowserProvider(window.ethereum);

                const accounts = await provider.send("eth_requestAccounts", []);

                const activeAddress = accounts[0];
                const signer = await provider.getSigner(activeAddress);

                console.log("Usando conta:", activeAddress);

                let fileHash = metadata.hash || "";
                if (!fileHash.startsWith("0x")) fileHash = "0x" + fileHash;
                if (fileHash.length !== 66) throw new Error("Hash inválido: " + fileHash);

                const format = metadata.format || "";
                const genre = metadata.genre || "";
                const duration = metadata.duration || 0;
                const extra = JSON.stringify(metadata);

                let holders = [];
                let shares = [];

                if (hasCoHolders.checked) {
                    const coholders = [];
                    document.querySelectorAll("#holdersList > div").forEach(div => {
                        const name = div.querySelector(".holderName")?.value.trim();
                        const percentage = parseFloat(div.querySelector(".holderPercent")?.value || "0");

                        if (name) {
                            coholders.push({ name, percentage });
                        }
                    });

                    const userAddress = await signer.getAddress();
                    holders = [userAddress];
                    shares = [100];
                } else {
                    const userAddress = await signer.getAddress();
                    holders = [userAddress];
                    shares = [100];
                }
                
                const factory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, signer);
                const contract = await factory.deploy(
                    title, artist, fileHash, priceWei, format, genre, duration, extra, holders, shares
                );
                await contract.waitForDeployment();
                const contractAddress = await contract.getAddress();
                console.log("Contrato criado:", contractAddress);

                const formData = new FormData();
                formData.append("file", file);
                formData.append("title", title);
                formData.append("artist", artist);
                formData.append("genre", document.getElementById("genre").value);
                formData.append("visibility", visibility);
                metadata.basePrice = priceWei.toString();
                formData.append("metadata", JSON.stringify(metadata));
                formData.append("contractAddress", contractAddress);
                const coverFile = document.getElementById("cover").files[0];
                if (coverFile) {
                    formData.append("cover", coverFile); // 👈 novo campo
                }

                if (hasCoHolders.checked) {
                    const coholders = [];
                    document.querySelectorAll("#holdersList > div").forEach(div => {
                        const name = div.querySelector(".holderName")?.value.trim();
                        const percentage = div.querySelector(".holderPercent")?.value.trim();
                        if (name) coholders.push({ name, percentage });
                    });

                    formData.append("coholders", JSON.stringify(coholders));
                }

                console.log("Metadata final:", metadata);
                console.log("FormData metadata:", formData.get("metadata"));


                const token = localStorage.getItem("authToken");
                await fetch(`${API}/api/tracks/upload`, {
                    method: "POST",
                    body: formData,
                    headers: { Authorization: "Bearer " + token }
                });

                status.textContent = `✅ Música enviada e contrato criado em ${await contract.getAddress()}`;

                setTimeout(() => {
                    window.location.href = "minhas-musicas.html";
                }, 1800);
            } catch (err) {
                console.error(err);
                status.textContent = " Erro: " + err.message;
            }
        });
    </script>
</body>

</html>